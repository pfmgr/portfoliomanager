# Portfolio Manager Admin

A self-hosted admin tool for importing Trade Republic PDFs and Deka CSVs, classifying instruments, and managing savings plans with a deterministic rebalancer workflow that can optionally explain its recommendations via an LLM.

## No Financial Advice
The suggestions generated by this application do not constitute financial advice and should always be critically examined and used with due caution.

## Table of Contents
- [Features](#features)
- [Architecture](#architecture)
- [Getting started](#getting-started)
- [Layer targets & rebalancer profiles](#layer-targets--rebalancer-profiles)
- [Savings plan management](#savings-plan-management)
- [Assessor (saving plan + one-time allocation)](#assessor-saving-plan--one-time-allocation)
- [Knowledge Base (optional)](#knowledge-base-optional)
  - [Knowledge Base quality gates](#knowledge-base-quality-gates)
- [Tests](#tests)
- [API highlights](#api-highlights)
- [Troubleshooting](#troubleshooting)

## Features
- Deterministic rebalancer proposals with optional LLM narrative (numeric proposals are rule-based).
- Saving plan projections blend projected gap weights (using effective holdings) with the current savings plan distribution; longer horizons are more conservative (linear 0.15 -> 0.45 over 1-120 months, configurable per profile).
- Rebalancer proposal table shows amounts only (Current EUR, Proposed EUR, Delta EUR) to avoid misleading percentages.
- Assessor view for saving plan adjustments and optional one-time allocations (see Assessor section).

## Architecture

- **PostgreSQL (`db_portfolio`)** stores imported snapshots, instruments, savings plans (`sparplans`), rebalancer history, and layer target configuration.
- **Spring Boot Admin API (`admin_spring`)** exposes the `/api/` surface, runs Liquibase migrations, applies classification rules, manages savings plans, and evaluates the rebalancer.
- **Vue 3 UI (`admin_frontend`)** uses the JWT login flow and lets you upload depot statements, manage reclassification rules, edit savings plans, adjust layer targets, and inspect rebalancer summaries.
- **Assessor** provides a separate assessment view/API (see Assessor section).
- **Metabase (optional)** exposes dashboards; remove or rebind the service in `docker-compose.yml` if you do not need it.

## Getting started

1. Copy `.env.sample` to `.env` and provide secrets such as:
   ```bash
   PORTFOLIO_DB_PASSWORD=<secure>
   METABASE_DB_PASSWORD=<secure>
   ADMIN_USER=admin
   ADMIN_PASS=secret
   JWT_ISSUER=portfolio-manager
   # LLM/KB (optional)
   LLM_PROVIDER=none
   KB_ENABLED=true
   KB_LLM_ENABLED=false
   # Local LLM (optional)
   # LLM_PROVIDER=ollama
   # LLM_PROVIDER_MODEL=llama3.1:8b
   # LLM_PROVIDER_BASE_URL=http://ollama:11434/v1
   # KB_SEARCH_PROVIDER=searxng
   # KB_SEARCH_BASE_URL=http://searxng:8080
   ADMIN_SPRING_BIND=127.0.0.1
   ADMIN_FRONTEND_BIND=127.0.0.1
   ```
2. Build or pull the application images (frontend + backend):
   ```bash
   ./build_docker_containers.sh
   ```
   If you have access to docker.io, you can also pull prebuilt images instead:
   ```bash
   docker pull fg1212/portfoliomanager-backend:latest
   docker pull fg1212/portfoliomanager-frontend:latest
   ```
3. Start the stack (compose only starts containers; it does not build images):
   ```bash
   docker compose up -d
   ```
4. Sign in at `/login` with `ADMIN_USER` / `ADMIN_PASS` (JWT login; Basic Auth is not used by the frontend).
5. Liquibase applies migrations automatically. To reset the database entirely, run:
   ```bash
   docker compose down -v
   docker compose up -d
   ```

## Layer targets & rebalancer profiles

- Layer identities are fixed: 1 = Global Core, 2 = Core-Plus, 3 = Themes, 4 = Individual Stocks, 5 = Unclassified.
- The backend seeds five rebalancer profiles (`Classic`, `Balanced`, `Growth`, `Aggressive`, `Opportunity`) from `layer_targets.json`. Each profile defines target weights, an acceptable variance (default 3%), minimum saving plan size, minimum rebalancing amount, projection horizon, and constraint thresholds (core minimum, layer 4/5 caps).
- Active profile state, layer names, custom overrides, and acceptable variance are stored in the `layer_target_config` table as JSONB (Postgres). Liquibase guarantees a single row with `id = 1` and migrates legacy configs into the new shape.
- When tolerances are exceeded, the rebalancer builds layer budgets by projecting holdings over the horizon and blending projected gap weights with the current savings plan distribution. Each profile defines a projection blend min/max (default 0.15 -> 0.45), and longer horizons weight the current distribution more to keep proposals conservative.
- If targets are within tolerance and constraints are satisfied, the proposed distribution mirrors the current distribution and the narrative confirms the fit.
- The optional LLM is only used for generating a narrative. The numeric proposal remains deterministic and rule-based.

## Savings plan management

- Savings plans live in `/api/sparplans` (still backed by the existing `sparplans` table). Java structures and DTOs now refer to `SavingPlan`.
- Import, export, create, update, and delete actions are available from the **Savings plans** page. Each plan records depot, ISIN, name, monthly amount, frequency, day, active flag, and last-changed date.

## Assessor (saving plan + one-time allocation)

- Open the **Assessor** view in the Admin UI and choose an assessment type (Saving Plan or One-Time Invest).
- Saving Plan assessments compare the current monthly savings plan distribution to the active profile and propose actions that respect minimum saving-plan size and minimum rebalancing thresholds.
- Saving Plan assessments use the same projection blend as the rebalancer; see **Layer targets & rebalancer profiles** for details.
- One-Time Invest assessments allocate the entered amount delta across layers (and instruments when KB data is complete) using current holdings gaps by default. Instrument buckets respect the minimum per-instrument amount.
- Instrument assessment scores are penalty-based (lower is better) and include: TER, risk indicator (SRI), valuation (P/E, P/B, EV/EBITDA), concentration (top holdings + region), single-stock premium (25), data quality, and layer-4 quality bonuses (EPS stability/growth, profitability, leverage, fair valuation). Layer-1/2 ETF region penalties are softer (10 at 80%, 15 at 90%).

## Knowledge Base (optional)

- Enable KB endpoints: set `KB_ENABLED=true` (default) and configure an LLM provider (e.g. `LLM_PROVIDER=openai` + `LLM_PROVIDER_API_KEY`).
- Enable LLM-based dossier extraction: set `KB_LLM_ENABLED=true` (false uses the stub extractor).
- Local LLM option (Ollama + SearxNG):
  - Start services: `docker compose --profile llm up -d` (internal-only) or `docker compose --profile llm-dev up -d` (exposes Ollama on `localhost:11434`).
  - Set `LLM_PROVIDER=ollama`, `LLM_PROVIDER_MODEL=llama3.1:8b`, `LLM_PROVIDER_BASE_URL=http://ollama:11434/v1`.
  - Configure SearxNG websearch with `KB_SEARCH_PROVIDER=searxng` and `KB_SEARCH_BASE_URL=http://searxng:8080`.
  - SearxNG JSON API is enabled via `services/searxng/settings.yml` (format `json`); container uses that file as `/etc/searxng/settings.yml`.
  - Add `SEARXNG_SECRET` to `.env` before starting the SearxNG container.
- The Knowledge Base view lets you review dossiers, run bulk research by ISIN, find alternatives, and monitor auto-refresh runs.
- KB settings live in `/api/kb/config` and are stored in `kb_config` (refresh interval, auto-approve, batch sizing, allowed domains, apply-to-overrides).
- Auto-approve and auto-refresh can introduce mistakes; spot-check results and use `docs/KB.md` for workflows and API details.
- Missing-data auto-fill runs after extractions (and can be triggered via `/api/kb/dossiers/{isin}/missing-data`). It patches only missing fields, appends citations, and retries websearch with primary sources plus issuer domains found in the first pass (single stocks: issuer IR/local exchange/Yahoo/StockAnalysis; ETFs: issuer factsheets/KIDs).

### Knowledge Base quality gates

- Dossier quality gates enforce sections/citations; extraction evidence gates verify that extracted values appear in the dossier.
- Evidence gates always use a category mapping (FUND/EQUITY/REIT/UNKNOWN) to decide which evidence keys must appear; this is not a fallback after a failure.
- By default the category mapping follows the active layer-target profile. Custom overrides apply only when enabled and saved for the active profile.
- REIT exception: when an instrument is detected as REIT, REIT evidence rules apply regardless of the layer mapping.
- Defaults are seeded from `services/app/backend/src/main/resources/kb_quality_gate_profiles.json` and stored in `kb_config`; the Admin UI edits them in **Profile Configuration -> Quality gates**.

## Tests

- Frontend tooling expects Node `v25.3.0`; keep local runtimes, CI, and Docker builds aligned.
- **Backend (Spring Boot, PostgreSQL int-test env, Liquibase, JaCoCo)**
  - Preferred: `services/app/backend/run-gradle-build.sh` (starts the int-test env, runs `./gradlew clean build`, and tears down).
  - Manual setup:
    - Start test DB once per session:
      ```bash
      docker compose -f services/app/backend/int-test-env/compose.yaml up -d
      ```
    - Then run tests:
      ```bash
      cd services/app/backend
      GRADLE_USER_HOME=/home/user/git/portfoliomanager/services/app/backend/.gradle_home ./gradlew test
      ```
    - Stop test DB when done:
      ```bash
      docker compose -f services/app/backend/int-test-env/compose.yaml down
      ```
- **Frontend unit tests (Vitest)**
  ```bash
  cd services/app/frontend
  npm test
  ```
- **Frontend e2e tests (Playwright)**
  Preferred runner:
  ```bash
  services/app/frontend/scripts/run-e2e.sh
  ```
  The script builds an isolated stack, runs the tests, and tears the stack down.
  Alternatively:
  ```bash
  docker compose -f services/app/frontend/docker-compose.yml -p portfoliomanager_e2e up -d --build
  E2E_BASE_URL=http://127.0.0.1:18090 npm run test:e2e
  ```

## API highlights

- `GET /api/layer-targets` returns the active profile key, display metadata, effective targets, layer names, and override status.
- `PUT /api/layer-targets` persists profile selection, overrides, and variance expectations.
- `POST /api/layer-targets/reset` restores the seeded profile configuration.
- `POST /api/rebalancer/run` starts a rebalancer job and returns a job id.
- `GET /api/rebalancer/run/{jobId}` returns job status plus summary and optional saved run.
- `GET /api/rebalancer/runs` lists saved rebalancer runs for auditing.
- `GET /api/rebalancer/runs/{runId}` fetches a saved run detail.
- `POST /api/assessor/run` returns deterministic saving-plan suggestions and optional one-time allocations (payload: `{ oneTimeAmountEur?, minimumInstrumentAmountEur?, depotScope? }`, profile is derived from the active config).

## Troubleshooting

- **Liquibase complaints**: stop the stack, tear down volumes (`docker compose down -v`), and restart so migrations reapply.
- **Imported file skipped**: the SHA hash already exists; use the force option to re-import.
- **Ruleset errors**: inspect the Spring Boot logs and verify that the ruleset name/version in the UI matches what is persisted in the database.
