# Dieser Workflow verwendet Aktionen, die nicht von GitHub zertifiziert sind.
# Sie werden von einem Drittanbieter bereitgestellt und unterliegen
# separaten Nutzungsbedingungen, Datenschutzbestimmungen und Support
# Onlinedokumentation.

# GitHub empfiehlt, Aktionen an einen Commit-SHA anzuheften.
# Um eine neuere Version zu erhalten, musst du den SHA aktualisieren.
# Du kannst auch auf ein Tag oder einen Branch verweisen, aber die Aktion kann sich ohne Vorwarnung Ã¤ndern.

name: Backend Docker image

on:
  pull_request:
  push:
    branches: [main]
  release:
    types: [published]

jobs:
  push_to_registry:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
      attestations: write
      id-token: write
    steps:
      - name: Check out the repo
        uses: actions/checkout@v5

      - name: Log in to Docker Hub
        if: ${{ github.event_name != 'pull_request' }}
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set image tags
        id: set-tags
        run: |
          set -euo pipefail
          IMAGE=index.docker.io/fg1212/portfoliomanager-backend

          # Default: empty tags to avoid accidental pushes
          echo "tags=" >> "$GITHUB_OUTPUT"

          # On pull request -> build-only tag
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            PR_NUMBER=$(jq -r .number < "$GITHUB_EVENT_PATH")
            echo "tags=${IMAGE}:pr-${PR_NUMBER}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # On push to main -> snapshot
          if [[ "${GITHUB_EVENT_NAME}" == "push" && "${GITHUB_REF}" == "refs/heads/main" ]]; then
            echo "tags=${IMAGE}:snapshot" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # On release published -> latest and the release tag
          if [[ "${GITHUB_EVENT_NAME}" == "release" ]]; then
            TAG_NAME=$(jq -r .release.tag_name < "$GITHUB_EVENT_PATH")
            if [[ -n "$TAG_NAME" && "$TAG_NAME" != "null" ]]; then
              echo "tags=${IMAGE}:latest,${IMAGE}:${TAG_NAME}" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

      - name: Build Docker image
        id: push
        if: ${{ steps.set-tags.outputs.tags != '' }}
        uses: docker/build-push-action@3b5e8027fcad23fda98b2e3ac259d8d67585f671
        with:
          context: services/app/backend
          file: ./services/app/backend/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.set-tags.outputs.tags }}

      - name: Generate artifact attestation
        if: ${{ github.event_name != 'pull_request' && steps.push.outputs.digest != '' }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: index.docker.io/fg1212/portfoliomanager-backend
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true
