services:
  db_metabase:
    image: postgres:16
    environment:
      POSTGRES_DB: metabase_app
      POSTGRES_USER: metabase
      POSTGRES_PASSWORD: ${METABASE_DB_PASSWORD}
    volumes:
      - metabase_data:/var/lib/postgresql/data
    restart: unless-stopped

  db_portfolio:
    image: postgres:16
    environment:
      POSTGRES_DB: portfolio
      POSTGRES_USER: portfolio
      POSTGRES_PASSWORD: ${PORTFOLIO_DB_PASSWORD}
    volumes:
      - portfolio_data:/var/lib/postgresql/data
    restart: unless-stopped

  metabase:
    image: metabase/metabase:latest
    environment:
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: metabase_app
      MB_DB_PORT: 5432
      MB_DB_USER: metabase
      MB_DB_PASS: ${METABASE_DB_PASSWORD}
      MB_DB_HOST: db_metabase
    ports:
      - "3000:3000"
    depends_on: [db_metabase]
    restart: unless-stopped

  admin_spring:
    image: fg1212/portfoliomanager-backend:${PORTFOLIO_MANAGER_VERSION:-latest}
    environment:
      DB_URL: jdbc:postgresql://db_portfolio:5432/portfolio
      DB_USER: portfolio
      DB_PASSWORD: ${PORTFOLIO_DB_PASSWORD}
      ADMIN_USER: ${ADMIN_USER}
      ADMIN_PASS: ${ADMIN_PASS}
      JWT_ISSUER: ${JWT_ISSUER:-portfolio-manager}
      LLM_PROVIDER: ${LLM_PROVIDER:-none}
      LLM_PROVIDER_MODEL: ${LLM_PROVIDER_MODEL:-gpt-5-nano}
      LLM_PROVIDER_API_KEY: ${LLM_PROVIDER_API_KEY}
      LLM_PROVIDER_BASE_URL: ${LLM_PROVIDER_BASE_URL:-https://api.openai.com/v1}
      LLM_PROVIDER_CONNECT_TIMEOUT_SECONDS: ${LLM_PROVIDER_CONNECT_TIMEOUT_SECONDS:-600}
      LLM_PROVIDER_READ_TIMEOUT_SECONDS: ${LLM_PROVIDER_READ_TIMEOUT_SECONDS:-600}
      LLM_EXTERNAL_PROVIDER: ${LLM_EXTERNAL_PROVIDER:-false}
      KB_ENABLED: ${KB_ENABLED:-true}
      KB_LLM_ENABLED: ${KB_LLM_ENABLED:-false}
      KB_SEARCH_PROVIDER: ${KB_SEARCH_PROVIDER:-searxng}
      KB_SEARCH_BASE_URL: ${KB_SEARCH_BASE_URL:-http://searxng:8080}
      KB_SEARCH_MAX_RESULTS: ${KB_SEARCH_MAX_RESULTS:-8}
      KB_SEARCH_MAX_SNIPPET_CHARS: ${KB_SEARCH_MAX_SNIPPET_CHARS:-1200}
      KB_SEARCH_TIMEOUT_SECONDS: ${KB_SEARCH_TIMEOUT_SECONDS:-15}
      APP_KB_ENABLED: ${KB_ENABLED:-true}
      APP_KB_LLM_ENABLED: ${KB_LLM_ENABLED:-false}
    depends_on:
      - db_portfolio
    ports:
      - "${ADMIN_SPRING_BIND:-127.0.0.1}:8089:8080"
    restart: unless-stopped

  admin_frontend:
    image: fg1212/portfoliomanager-frontend:${PORTFOLIO_MANAGER_VERSION:-latest}
    depends_on:
      - admin_spring
    ports:
      - "${ADMIN_FRONTEND_BIND:-127.0.0.1}:8080:80"
    restart: unless-stopped

  searxng:
    image: fg1212/seaxng-portfoliomanager:${PORTFOLIO_MANAGER_VERSION:-latest}
    build:
      context: ./services/searxng
    environment:
      SEARXNG_BASE_URL: ${SEARXNG_BASE_URL:-http://searxng:8080/}
      SEARXNG_SECRET: ${SEARXNG_SECRET}
    restart: unless-stopped
    profiles: ["llm", "llm-dev"]

  ollama:
    image: ollama/ollama:latest
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    profiles: ["llm"]

  ollama_dev:
    image: ollama/ollama:latest
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "11434:11434"
    restart: unless-stopped
    profiles: ["llm-dev"]
    networks:
      default:
        aliases:
          - ollama

volumes:
  metabase_data:
  portfolio_data:
  ollama_data:
